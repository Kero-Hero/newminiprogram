<!--pages/log/log.wxml-->
<view class="page">
  <!-- æ—¥å¿—ç±»å‹åˆ‡æ¢ -->
  <view class="log-type-tabs">
    <view class="tab-item {{activeTab === 'user' ? 'active' : ''}}" bindtap="switchTab" data-tab="user">
      <text class="tab-text">ç”¨æˆ·æ—¥å¿—</text>
      <view class="tab-badge" wx:if="{{userLogCount > 0}}">{{userLogCount}}</view>
    </view>
    <view class="tab-item {{activeTab === 'device' ? 'active' : ''}}" bindtap="switchTab" data-tab="device">
      <text class="tab-text">è®¾å¤‡æ—¥å¿—</text>
      <view class="tab-badge" wx:if="{{deviceLogCount > 0}}">{{deviceLogCount}}</view>
    </view>
  </view>

  <!-- ç­›é€‰å™¨ -->
  <view class="filter-section">
    <view class="filter-row">
      <picker mode="selector" range="{{logLevels}}" range-key="label" bindchange="onLogLevelChange">
        <view class="filter-picker">
          <text>{{selectedLogLevel.label || 'æ‰€æœ‰çº§åˆ«'}}</text>
          <text class="picker-arrow">â–¼</text>
        </view>
      </picker>
      <picker mode="date" value="{{filterDate}}" bindchange="onDateChange">
        <view class="filter-picker">
          <text>{{filterDate || 'é€‰æ‹©æ—¥æœŸ'}}</text>
          <text class="picker-icon">ğŸ“…</text>
        </view>
      </picker>
    </view>
    <view class="search-bar">
      <input class="search-input" placeholder="æœç´¢æ—¥å¿—å†…å®¹" value="{{searchKeyword}}" bindinput="onSearchInput" />
      <view class="search-icon">ğŸ”</view>
    </view>
  </view>

  <!-- æ—¥å¿—ç»Ÿè®¡ -->
  <view class="log-stats">
    <view class="stat-item">
      <view class="stat-number">{{totalLogs}}</view>
      <view class="stat-label">æ€»æ—¥å¿—</view>
    </view>
    <view class="stat-item">
      <view class="stat-number text-danger">{{errorLogs}}</view>
      <view class="stat-label">é”™è¯¯</view>
    </view>
    <view class="stat-item">
      <view class="stat-number text-warning">{{warningLogs}}</view>
      <view class="stat-label">è­¦å‘Š</view>
    </view>
    <view class="stat-item">
      <view class="stat-number text-success">{{infoLogs}}</view>
      <view class="stat-label">ä¿¡æ¯</view>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-container" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- æ—¥å¿—åˆ—è¡¨ -->
  <view class="log-list" wx:else>
    <view class="log-item" wx:for="{{filteredLogs}}" wx:key="id" bindtap="viewLogDetail" data-log="{{item}}">
      <view class="log-header">
        <view class="log-level level-{{item.level}}">{{item.levelText}}</view>
        <view class="log-time">{{item.formattedTime}}</view>
      </view>
      <view class="log-content">
        <text class="log-message">{{item.message || item.action}}</text>
        <view class="log-meta">
          <text class="log-source" wx:if="{{item.source}}">æ¥æº: {{item.source}}</text>
          <text class="log-ip" wx:if="{{item.ip}}">IP: {{item.ip}}</text>
          <text class="log-device" wx:if="{{item.deviceName}}">è®¾å¤‡: {{item.deviceName}}</text>
        </view>
      </view>
      <view class="log-details" wx:if="{{item.details}}">
        <text class="details-text">{{item.details}}</text>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{filteredLogs.length === 0 && !loading}}">
      <view class="empty-icon">ğŸ“‹</view>
      <view class="empty-text">{{searchKeyword ? 'æœªæ‰¾åˆ°ç›¸å…³æ—¥å¿—' : 'æš‚æ— æ—¥å¿—è®°å½•'}}</view>
      <view class="empty-desc">{{searchKeyword ? 'è¯·å°è¯•å…¶ä»–å…³é”®è¯æˆ–è°ƒæ•´ç­›é€‰æ¡ä»¶' : (activeTab === 'user' ? 'ç”¨æˆ·æ“ä½œæ—¥å¿—ä¼šåœ¨è¿™é‡Œæ˜¾ç¤º' : 'è®¾å¤‡æ“ä½œæ—¥å¿—ä¼šåœ¨è¿™é‡Œæ˜¾ç¤º')}}</view>
    </view>
  </view>

  <!-- åŠ è½½æ›´å¤š -->
  <view class="load-more" wx:if="{{hasMore && !loading}}" bindtap="loadMoreLogs">
    <text>åŠ è½½æ›´å¤š</text>
  </view>

  <!-- æ—¥å¿—è¯¦æƒ…å¼¹çª— -->
  <view class="modal-overlay" wx:if="{{showLogDetail}}" bindtap="hideLogDetail">
    <view class="modal-content" catchtap="">
      <view class="modal-header">
        <text class="modal-title">æ—¥å¿—è¯¦æƒ…</text>
        <view class="modal-close" bindtap="hideLogDetail">âœ•</view>
      </view>
      <view class="modal-body">
        <view class="detail-section" wx:if="{{selectedLog}}">
          <view class="detail-item">
            <text class="detail-label">çº§åˆ«:</text>
            <view class="log-level level-{{selectedLog.level}}">{{selectedLog.levelText}}</view>
          </view>
          <view class="detail-item">
            <text class="detail-label">æ—¶é—´:</text>
            <text class="detail-value">{{selectedLog.timestamp}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">æ¶ˆæ¯:</text>
            <text class="detail-value">{{selectedLog.message || selectedLog.action}}</text>
          </view>
          <view class="detail-item" wx:if="{{selectedLog.source}}">
            <text class="detail-label">æ¥æº:</text>
            <text class="detail-value">{{selectedLog.source}}</text>
          </view>
          <view class="detail-item" wx:if="{{selectedLog.ip}}">
            <text class="detail-label">IPåœ°å€:</text>
            <text class="detail-value">{{selectedLog.ip}}</text>
          </view>
          <view class="detail-item" wx:if="{{selectedLog.deviceName}}">
            <text class="detail-label">è®¾å¤‡:</text>
            <text class="detail-value">{{selectedLog.deviceName}}</text>
          </view>
          <view class="detail-item" wx:if="{{selectedLog.details}}">
            <text class="detail-label">è¯¦ç»†ä¿¡æ¯:</text>
            <text class="detail-value">{{selectedLog.details}}</text>
          </view>
          <view class="detail-item" wx:if="{{selectedLog.userId}}">
            <text class="detail-label">ç”¨æˆ·ID:</text>
            <text class="detail-value">{{selectedLog.userId}}</text>
          </view>
        </view>
      </view>
      <view class="modal-footer">
        <button class="btn btn-primary" bindtap="hideLogDetail">å…³é—­</button>
      </view>
    </view>
  </view>
</view> 